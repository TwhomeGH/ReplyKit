name: Check Changes & Trigger Tag

on:
  push:
    paths:
      - "liveApp*/**"
      - "ReplyKIT*/**"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Get latest tag
      - name: Get latest tag
        id: get_tag
        run: |
          latest_tag=$(git tag --list "v*" | sort -V | tail -n1)
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest tag: $latest_tag"

      # 3️⃣ Compare changes in monitored paths
      - name: Compare changes
        id: diff
        run: |
          CHANGED=$(git diff --name-only ${{ steps.get_tag.outputs.latest_tag }} HEAD | grep -E '^App/|^Shared/|^Modules/' || true)
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT
          if [ -z "$CHANGED" ]; then
            echo "No relevant changes detected. Exiting..."
            exit 0
          fi
          echo "Changes detected in relevant paths: $CHANGED"

      # 4️⃣ Create new tag with auto-increment (patch/minor/major)
      - name: Create new tag
        run: |
          latest_tag="${{ steps.get_tag.outputs.latest_tag }}"
          if [ -z "$latest_tag" ]; then
            NEW_TAG="v0.0.1"
          else
            IFS='.' read -r major minor patch <<< "${latest_tag#v}"

            # 遞增 patch
            patch=$((patch + 1))

            # patch 超過 9 → 進位 minor
            if [ "$patch" -gt 9 ]; then
              patch=0
              minor=$((minor + 1))
            fi

            # minor 超過 9 → 進位 major
            if [ "$minor" -gt 9 ]; then
              minor=0
              major=$((major + 1))
            fi

            NEW_TAG="v$major.$minor.$patch"
          fi

          echo "New tag: $NEW_TAG"

          # 設定 git user & push tag
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag $NEW_TAG
          git push origin $NEW_TAG
